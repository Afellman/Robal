<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Dashboard</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="./assets/css/post.css">
  <link href="https://fonts.googleapis.com/css?family=Vollkorn+SC" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-database.js"></script>
</head>
<style>

body, .container {
  background: url('./assets/images/cwork.jpg') !important;
}

  * {
    font-size: 15px;
    font-family: 'Vollkorn SC', serif;
  }
  .navbar-brand {
    font-size: 30px;

}
  #chat-area p {
    margin-bottom: 2px;
    background: #aaa8a8b9;
    display: inline-block;
    padding: 3px 5px 3px 5px;
    border-radius: 10px;
  }
  .subtle {
    color: #656565;
  }

  #dashboard-container {
    max-width: 960px;
    padding: 20px 50px 20px 50px
  }

  .chat-card {
    padding: 10px;
  }

  #chat-col {
  
  }

  #chat-submit {
    vertical-align: bottom;
    margin-left: 10px;
  }

  .inbox-message:hover {
    cursor: pointer;
  }

  .post-list-item:hover {
    cursor: pointer;
    color: rgb(126, 125, 125);
  }
 

  #new-chat-box {
    width: 50%;
    margin-top: 10px;
  }
  
  #dashboard-container {
    max-width: 960px;
    padding: 20px 50px 20px 50px;
    background: #F7F7F9;
  }
  .panel-heading, .panel-title {
    color: rgb(248, 248, 248);
    background: #708090 !important;
  }
  .dash-top-row {
    margin-bottom: 20px;
  }

</style>
<body>
    <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="#">Robal</a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home<span class="sr-only"></span></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="post.html">Post a Job</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="jobposts.html">Job Listings</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Become a Member
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="register.html">Member Registration</a>
              <a class="dropdown-item" href="login.html">Login</a>
            </div>
          </li>
          <li class="nav-item">
              <button type="button" class="btn btn-default btn-sm" id="sign-out-btn" style="margin-top: 10px">
                <a class="glyphicon glyphicon-log-out" href="index.html">Log out</a>
             </button>
            </li>
        </ul>
      </div>
      </nav>
  <div class="content-wrapper">
    <div class="container" id="dashboard-container">
      <div class="row mb-5">
        <h1 id="user-title">User</h1>
      </div>
      <hr>
      <div class="row dash-top-row">
        <div class="col-md-4">
          <div class="panel panel-default text-center">
            <div class="panel-heading">
              <h3 class="panel-title">Wallet</h3>
            </div>
            <div class="panel-body">
              <p id="wallet-amount" class="card-text d-inline-block"></p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="panel panel-default text-center">
            <div class="panel-heading">
              <h3 class="panel-title">Inbox</h3>
            </div>
            <div class="panel-body">
              <button class="btn btn-primary" data-toggle="modal" data-target="#inboxModal">Check Inbox</button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="panel panel-default text-center">
            <div class="panel-heading">
              <h3 class="panel-title">Jobs Completed</h3>
            </div>
            <div class="panel-body">
                <p id="jobs-completed" class="card-text d-inline-block"></p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="panel panel-default text-center">
            <div class="panel-heading">
              <h3 class="panel-title">My Posted Jobs</h3>
            </div>
            <div class="panel-body">
              <ul id="posted-jobs">
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-8" id="chat-col">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Chat about everything Robal!</h3>
            </div>
            <div class="panel-body">
              <div id="chat-area">
              </div>
              <div class="form-group form-inline" id="new-chat-div">
                <input type='text' id='new-chat-box' class="form-control"/>
                <button id="chat-submit" class="btn btn-primary">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="inboxModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Inbox</h4>
        </div>
        <div class="modal-body">
          <p class="subtle">click to delete message</p>
          <ul id="inbox">
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="myPostedJobsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Posted Job</h4>
        </div>
        <div class="modal-body">
          <div id="posted-jobs-expanded">
          </div>
        </div>
        <div class="modal-footer">
          <p>Delete completed jobs</p>
            <button id="delete-job"type="button" class="btn btn-primary" data-dismiss="modal">delete job</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal">close</button> 
        </div>
      </div>
    </div>
  </div>
  <script
  src="https://code.jquery.com/jquery-3.2.1.js"
  integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
  crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzTLxC73DXyLzgblZUBKMdM4_LJgnKmKY&callback=initMap"
async defer></script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script>
    		$(document).ready(function() {
				// Initialzing Firebase
				var config = {
					apiKey: "AIzaSyCRUos4srVsw2Gw6_ghM2YTUSXdm-L6kEo",
					authDomain: "robal-f2619.firebaseapp.com",
					databaseURL: "https://robal-f2619.firebaseio.com",
					projectId: "robal-f2619",
					storageBucket: "robal-f2619.appspot.com",
					messagingSenderId: "1011207778959"
				};
				firebase.initializeApp(config);
				
				// Storing Firebase in database
        var database = firebase.database();
        var auth = firebase.auth();
        var postNumber = 0;
        var jobAcceptMessages = [];
        var user;
        var userInfo;
				// function to store snapshot data in an array
				function snapshotToArray(snapshot) {
					var returnArr = [];

					snapshot.forEach(function(childSnapshot) {
						var item = childSnapshot.val();
						item.key = childSnapshot.key;

						returnArr.push(item);
					});
					return returnArr;
				};
        // Checking if signed in and assigning unique user id locally
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            user = user.email
            console.log("User is signed in.")
            populateWithUserData(user);

          } else {
            console.log('No user is signed in.')
          }
        });

        // getting user data from firebase
        function populateWithUserData(userEmail){
          database.ref('/registration').on('value', function(snapshot) {
            var userArray = snapshotToArray(snapshot);
            for (var i = 0; i < userArray.length; i++) {
              if (userArray[i].eaddress == userEmail){
                console.log('user found')
                var info = userArray[i];
                addUserInfoToDom(info);
              }
            }
          })
        };

        // Adding user info to the DOM -----------------
        function addUserInfoToDom(userInfo) {
          $('#user-title').text(userInfo.name + " " + userInfo.lastname)
          $('#wallet-amount').text(userInfo.hours + " hours");
          $('#jobs-completed').text(userInfo.jobs_completed);

          // grabbing and appending inbox messages
          database.ref('/jobAcceptMsg').on('value', function (snapshot) {
          var messagesToUser;
          var messages = snapshotToArray(snapshot);
          for (var i = 0; i < messages.length; i++) {
            console.log(messages[i])
            if (messages[i].to == userInfo.eaddress) {
             var msg = messages[i].msg;
              $('#inbox').prepend('<li class="inbox-message">'+ msg + ' - <em>from: '+ messages[i].from + '</em></li>');
            // Function to clear messages (need to refresh firebase after delete)
            }
          }
          
          $('.inbox-message').on('click', function (){
              $(this).remove();
            });
        });
        // grabbing and appending jobs posted by user
        database.ref("/jobPost").on('value', function(snapshot) {
        var posts = [];
				jobPostArray = snapshotToArray(snapshot);
				console.log(jobPostArray)
				// running through the array of posts, storing each key/value locally, 
				// then appending them to the dom
				for (var i = 0; i < jobPostArray.length; i++) {
          if (jobPostArray[i].eaddress == userInfo.eaddress) {
            var work = jobPostArray[i].work;
            posts.push(jobPostArray[i])
            
            console.log(posts)
            $('#posted-jobs').prepend('<li class="post-list-item" data-post="' + postNumber + '"data-toggle="modal" data-target="#myPostedJobsModal">'+ work + '</li>');
            postNumber++
          // Function to clear messages (need to refresh firebase after delete)
          };
        };
        $('.post-list-item').on('click', function() {
          var dataPost = $(this).attr('data-post');
          console.log(dataPost)
          console.log(posts)
          var fname = posts[dataPost].name;
          var lname = posts[dataPost].lastname;
          var email = posts[dataPost].eaddress;
          var hours = posts[dataPost].hrs;
          var location = posts[dataPost].area;
          var description = posts[dataPost].need;
          var title = posts[dataPost].work;
          // Appeding everything to the DOM
          var container = '<div id="job-list-item"class="mt-3"></div>';
          var title =  '<div class="row title-row"><div class="col-md-12"><h3 id="job-title">' + title + '</h3></div></div>';
          var jobSpec = '<div class="ml-2 row"><div class="col-md-12"><p class="subtle">Employeer is: ' + fname + " " + lname +' - ' + email + ' <br>'+ hours +' hours at ' + location + '</p>' +'<p id="job-description">'+ description + '</p></div></div>';
          $('#posted-jobs-expanded').html(container);
          $('#job-list-item').append(title);
          $('#job-list-item').append(jobSpec);  

          // Need to update firebase after delete
          $('#delete-job').on('click', function (){
            $('*[data-post="'+ dataPost + '"]').remove();

        });     
        });
			});
        };
				// Grabbing and appending chatbox 
        database.ref('/chatBox/posts').on('value', function(snapshot) {
					chatBoxArray = snapshotToArray(snapshot);
					console.log(chatBoxArray)
					postNumber = snapshot.postNumber;
                    $('#chat-area').empty();
					// running through the array of posts, storing each locally, 
					// then appending it to the dom
					for (var i = chatBoxArray.length - 1; i > chatBoxArray.length - 7; i --){
						var line = chatBoxArray[i];
						$('#chat-area').prepend('<p> - ' + line + '</p><br>');
					};
				});
				database.ref('/chatBox').on('value', function(snapshot) {
					postNumber = snapshot.val().postNumber;
				});
				$('#chat-submit').on('click', function(event) {
          event.preventDefault(); 
					var postText = $('#new-chat-box').val();
					database.ref('/chatBox/posts').push(postText)
          $('#new-chat-box').val("");
				});
			
        
        $("#sign-out-btn" ).on("click", function(event) {
          firebase.auth().signOut().then(function() {
          // Sign-out successful.
          }).catch(function(error) {
          // An error happened.
          });
        });


      // End document.ready
			});

    
  </script>
	
</body>

</html>
